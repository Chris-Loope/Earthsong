---
import events from '../../data/cycle.json';
const sorted = [...events].sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());
const years = [...new Set(sorted.map(e => new Date(e.start).getFullYear()))].sort();
const tags = [...new Set(sorted.flatMap(e => e.tags || []))].sort();
const currentYear = new Date().getFullYear();
const defaultYear = years.includes(currentYear) ? currentYear : years[0];

const tagLabels: Record<string, string> = {
  'full-moon': 'Full Moon',
  'new-moon': 'New Moon',
  'eclipse': 'Eclipse',
  'season': 'Season',
};
---

<!-- Year tabs -->
<div class="flex flex-wrap gap-2 mb-4" role="tablist" aria-label="Filter by year">
  {years.map(year => (
    <button
      role="tab"
      data-year={year}
      aria-selected={year === defaultYear ? "true" : "false"}
      class:list={[
        "year-tab px-3 py-1.5 rounded-lg text-sm font-medium transition-colors",
        year === defaultYear
          ? "bg-earth text-white"
          : "bg-ink/5 text-ink/70 hover:bg-ink/10"
      ]}
    >
      {year}
    </button>
  ))}
</div>

<!-- Tag filter chips -->
<div class="flex flex-wrap gap-2 mb-6" role="group" aria-label="Filter by type">
  <button
    data-tag="all"
    class="tag-chip px-3 py-1 rounded-full text-xs font-medium transition-colors bg-earth text-white"
  >
    All
  </button>
  {tags.map(tag => (
    <button
      data-tag={tag}
      class="tag-chip px-3 py-1 rounded-full text-xs font-medium transition-colors bg-ink/5 text-ink/70 hover:bg-ink/10"
    >
      {tagLabels[tag] || tag}
    </button>
  ))}
</div>

<!-- Event count -->
<p class="text-sm text-ink/60 mb-4" id="event-count"></p>

<!-- Event list -->
<ul class="space-y-3" id="event-list">
  {sorted.map(e => (
    <li
      class="event-item rounded border border-ink/10 bg-white p-4"
      data-year={new Date(e.start).getFullYear()}
      data-tags={(e.tags || []).join(',')}
    >
      <div class="flex items-center gap-2">
        <span class="font-medium">{e.title}</span>
        {(e.tags || []).map(tag => (
          <span class:list={[
            "inline-block px-2 py-0.5 rounded-full text-[10px] font-medium uppercase tracking-wide",
            tag === 'eclipse' && "bg-fire/10 text-fire",
            tag === 'full-moon' && "bg-water/10 text-water",
            tag === 'new-moon' && "bg-ink/5 text-ink/60",
            tag === 'season' && "bg-earth/10 text-earth",
          ]}>{tagLabels[tag] || tag}</span>
        ))}
      </div>
      <div class="text-sm text-ink/70 mt-1">
        <time datetime={e.start}>
          {new Date(e.start).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric',
            ...(e.start.includes('T') ? { hour: '2-digit', minute: '2-digit' } : {})
          })}
        </time>
      </div>
    </li>
  ))}
</ul>

<script define:vars={{ defaultYear }}>
  let activeYear = defaultYear;
  let activeTag = 'all';

  function filterEvents() {
    const items = document.querySelectorAll('.event-item');
    let count = 0;
    items.forEach(item => {
      const itemYear = Number(item.dataset.year);
      const itemTags = item.dataset.tags ? item.dataset.tags.split(',') : [];
      const yearMatch = itemYear === activeYear;
      const tagMatch = activeTag === 'all' || itemTags.includes(activeTag);
      const visible = yearMatch && tagMatch;
      item.style.display = visible ? '' : 'none';
      if (visible) count++;
    });
    const el = document.getElementById('event-count');
    if (el) el.textContent = count + ' event' + (count !== 1 ? 's' : '');
  }

  document.querySelectorAll('.year-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      activeYear = Number(btn.dataset.year);
      document.querySelectorAll('.year-tab').forEach(b => {
        b.classList.remove('bg-earth', 'text-white');
        b.classList.add('bg-ink/5', 'text-ink/70');
        b.setAttribute('aria-selected', 'false');
      });
      btn.classList.remove('bg-ink/5', 'text-ink/70');
      btn.classList.add('bg-earth', 'text-white');
      btn.setAttribute('aria-selected', 'true');
      filterEvents();
    });
  });

  document.querySelectorAll('.tag-chip').forEach(btn => {
    btn.addEventListener('click', () => {
      activeTag = btn.dataset.tag;
      document.querySelectorAll('.tag-chip').forEach(b => {
        b.classList.remove('bg-earth', 'text-white');
        b.classList.add('bg-ink/5', 'text-ink/70');
      });
      btn.classList.remove('bg-ink/5', 'text-ink/70');
      btn.classList.add('bg-earth', 'text-white');
      filterEvents();
    });
  });

  // Initial filter
  filterEvents();
</script>

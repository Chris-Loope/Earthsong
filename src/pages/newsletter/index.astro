---
import Layout from "@/components/Layout.astro";
import SubscribeForm from "@/components/SubscribeForm.astro";

// Import all newsletter MDX files
const issueModules = import.meta.glob("../../content/newsletter/*.mdx", { eager: true }) as Record<string, any>;

// Parse frontmatter and sort newest-first
const sorted = Object.entries(issueModules)
  .map(([path, mod]) => ({
    title: mod.frontmatter.title as string,
    issueNum: mod.frontmatter.issue as number,
    date: new Date(mod.frontmatter.date),
    summary: mod.frontmatter.summary as string,
    slug: path.split("/").pop()!.replace(/\.mdx$/, ""),
  }))
  .sort((a, b) => b.date.getTime() - a.date.getTime());
---

<Layout
  title="Newsletter — Earthsong"
  description="Seasonal letters on nature, spirit, and community from the Earthsong community."
>
  <h1 class="text-2xl font-semibold mb-2">Newsletter</h1>
  <p class="text-ink/70 mb-8">
    Seasonal letters on nature, spirit, and community. Published around the
    solstices and equinoxes.
  </p>

  <!-- Subscribe form -->
  <SubscribeForm />

  <!-- Archive -->
  <section class="mt-12">
    <h2 class="text-lg font-semibold text-earth mb-4">Archive</h2>

    <div class="space-y-4">
      {sorted.map((issue) => (
        <a
          href={`/newsletter/${issue.slug}`}
          class="block rounded-xl border border-ink/10 bg-white p-5 hover:border-earth/30 hover:shadow-sm transition-all group"
        >
          <div class="flex items-baseline gap-3 mb-1">
            <span class="text-xs font-medium text-ink/40">
              #{String(issue.issueNum).padStart(3, "0")}
            </span>
            <h3 class="font-semibold group-hover:text-earth transition-colors">
              {issue.title}
            </h3>
          </div>
          <time
            datetime={issue.date.toISOString().slice(0, 10)}
            class="text-xs text-ink/50"
          >
            {issue.date.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })}
          </time>
          {issue.summary && (
            <p class="mt-2 text-sm text-ink/70 line-clamp-2">
              {issue.summary}
            </p>
          )}
        </a>
      ))}
    </div>

    {sorted.length === 0 && (
      <p class="text-ink/50 text-sm">
        No issues yet — subscribe above to be the first to know.
      </p>
    )}
  </section>
</Layout>
